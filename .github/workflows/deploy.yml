name: Deploy to Cloud Functions

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: growth-force-project
  FUNCTION_NAME: web-pixel-billing-batch
  REGION: asia-northeast1
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup credentials file
      run: |
        mkdir -p ~/.config/gcloud
        cat > ~/.config/gcloud/application_default_credentials.json << EOF
        {
          "type": "service_account",
          "project_id": "${{ secrets.GCP_PROJECT_ID }}",
          "private_key_id": "${{ secrets.GCP_PRIVATE_KEY_ID }}",
          "private_key": "${{ secrets.GCP_PRIVATE_KEY }}",
          "client_email": "${{ secrets.GCP_CLIENT_EMAIL }}",
          "client_id": "${{ secrets.GCP_CLIENT_ID }}",
          "auth_uri": "https://accounts.google.com/o/oauth2/auth",
          "token_uri": "https://oauth2.googleapis.com/token",
          "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
          "client_x509_cert_url": "${{ secrets.GCP_CLIENT_X509_CERT_URL }}",
          "universe_domain": "googleapis.com"
        }
        EOF
        
    - name: Authenticate to Google Cloud
      run: |
        gcloud auth activate-service-account --key-file=~/.config/gcloud/application_default_credentials.json
        gcloud config set project $PROJECT_ID

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Deploy to Cloud Functions
      run: |
        gcloud functions deploy $FUNCTION_NAME \
          --gen2 \
          --runtime=nodejs18 \
          --region=$REGION \
          --source=. \
          --entry-point=processBilling \
          --trigger-http \
          --allow-unauthenticated \
          --memory=512Mi \
          --timeout=540s \
          --max-instances=1 \
          --set-env-vars="GOOGLE_CLOUD_PROJECT=$PROJECT_ID,NODE_ENV=production,BILLING_RATE_PER_MILLION=10.0,TIMEZONE=Asia/Tokyo,BILLING_TIME=01:00"

    - name: Create or update Cloud Scheduler job
      run: |
        # Get function trigger URL
        FUNCTION_URL=$(gcloud functions describe $FUNCTION_NAME --region=$REGION --format='value(serviceConfig.uri)')
        
        # Check if scheduler job exists
        if gcloud scheduler jobs describe shopify-billing-batch --location=$REGION --quiet 2>/dev/null; then
          echo "Updating existing scheduler job..."
          gcloud scheduler jobs update http shopify-billing-batch \
            --location=$REGION \
            --schedule="0 1 * * *" \
            --time-zone="Asia/Tokyo" \
            --uri="$FUNCTION_URL" \
            --http-method=POST \
            --headers="Content-Type=application/json" \
            --message-body="{}"
        else
          echo "Creating new scheduler job..."
          gcloud scheduler jobs create http shopify-billing-batch \
            --location=$REGION \
            --schedule="0 1 * * *" \
            --time-zone="Asia/Tokyo" \
            --uri="$FUNCTION_URL" \
            --http-method=POST \
            --headers="Content-Type=application/json" \
            --message-body="{}"
        fi

    - name: Output function URL
      run: |
        echo "Function deployed successfully!"
        gcloud functions describe $FUNCTION_NAME --region=$REGION --format='value(serviceConfig.uri)'