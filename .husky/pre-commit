#!/usr/bin/env sh

echo "ðŸ” Running pre-commit checks..."

# Run lint-staged for changed files only
echo "ðŸ“ Running lint-staged..."
npx lint-staged
if [ $? -ne 0 ]; then
    echo "âŒ Linting failed! Please fix errors before committing."
    exit 1
fi

# Run TypeScript compile check
echo "ðŸ”¨ Checking TypeScript compilation..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
    echo "âŒ TypeScript compilation failed! Please fix type errors before committing."
    exit 1
fi

# Validate package.prod.json dependencies
echo "ðŸ“¦ Validating package.prod.json dependencies..."
node -e "
  const pkg = require('./package.json');
  const prodPkg = require('./package.prod.json');
  
  const runtimeDeps = pkg.dependencies || {};
  const prodDeps = prodPkg.dependencies || {};
  
  const missing = [];
  for (const dep of Object.keys(runtimeDeps)) {
    if (!prodDeps[dep]) {
      missing.push(dep);
    }
  }
  
  if (missing.length > 0) {
    console.error('âŒ Missing dependencies in package.prod.json:');
    missing.forEach(dep => console.error('  -', dep));
    console.error('Please add missing dependencies to package.prod.json');
    process.exit(1);
  }
  
  console.log('âœ… All runtime dependencies are present in package.prod.json');
"
if [ $? -ne 0 ]; then
    exit 1
fi

echo "âœ… All pre-commit checks passed!"